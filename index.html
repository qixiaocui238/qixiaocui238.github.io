<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>省间电价计算器</title>
    <!-- 引入PDF生成相关库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* 全局样式和动画 */
        * {
            box-sizing: border-box;
        }

        /* 错误消息样式 */
        .error-message {
            color: #d9534f;
            font-size: 0.875rem;
            margin-top: 0.25rem;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        .hidden {
            display: none;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
    
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            margin-top: 20px;
            border-radius: 12px;
            transition: transform 0.3s ease;
        }
        
        .container:hover {
            transform: translateY(-2px);
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-weight: 600;
            position: relative;
            padding-bottom: 15px;
        }
        
        h1::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 3px;
            background: linear-gradient(to right, #3498db, #2ecc71);
            border-radius: 3px;
        }
        
        /* 标签页样式 */
        .tab-container {
            margin-bottom: 30px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }
        
        .tab-button {
            padding: 15px 30px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            position: relative;
            overflow: hidden;
        }
        
        .tab-button::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: -100%;
            width: 100%;
            height: 3px;
            background: #3498db;
            transition: all 0.3s ease;
        }
        
        .tab-button:hover::before {
            left: 0;
        }
        
        .tab-button.active {
            color: #2c3e50;
            border-bottom-color: #3498db;
            font-weight: 600;
        }
        
        .tab-button.active::before {
            left: 0;
        }
        
        .tab-content {
            display: none;
            padding: 20px 0;
            animation: fadeIn 0.5s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* 表单样式 */
        .form-group {
            margin-bottom: 25px;
            position: relative;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
            font-size: 14px;
        }
        
        select, input[type="number"], input[type="text"] {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background-color: white;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .radio-group {
            display: flex;
            gap: 30px;
            padding: 10px 0;
        }
        
        .radio-group label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: normal;
            transition: color 0.3s ease;
        }
        
        .radio-group label:hover {
            color: #3498db;
        }
        
        .radio-group input[type="radio"] {
            width: auto;
            margin-right: 8px;
            accent-color: #3498db;
        }
        
        .button-group {
            display: flex;
            gap: 20px;
            margin-top: 40px;
        }
        
        button {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        
        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0));
            transform: translateX(-100%);
            transition: transform 0.4s ease;
            z-index: -1;
        }
        
        button:hover::before {
            transform: translateX(100%);
        }
        
        .btn-calculate {
            background-color: #3498db;
            color: white;
            min-width: 120px;
        }
        
        .btn-calculate:hover {
            background-color: #2980b9;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
            transform: translateY(-1px);
        }
        
        .btn-calculate:active {
            transform: translateY(0);
        }
        
        .btn-reset {
            background-color: #e74c3c;
            color: white;
            min-width: 120px;
        }
        
        .btn-reset:hover {
            background-color: #c0392b;
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
            transform: translateY(-1px);
        }
        
        .btn-reset:active {
            transform: translateY(0);
        }
        
        /* 结果卡片样式 */
        .result-card {
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            background-color: #fafafa;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .result-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: linear-gradient(to bottom, #3498db, #2ecc71);
        }
        
        .result-card:hover {
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .route-info {
            font-weight: 600;
            color: #2c3e50;
            font-size: 18px;
        }
        
        .best-price-tag {
            background-color: #27ae60;
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(39, 174, 96, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(39, 174, 96, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(39, 174, 96, 0);
            }
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
        }
        
        .info-item:hover {
            background-color: rgba(240, 240, 240, 0.5);
        }
        
        .info-label {
            color: #666;
            font-size: 14px;
        }
        
        .info-value {
            font-weight: 600;
            color: #2c3e50;
            font-size: 16px;
        }
        
        .details-button {
            margin-top: 20px;
            background-color: #95a5a6;
            color: white;
            padding: 10px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .details-button:hover {
            background-color: #7f8c8d;
            transform: translateY(-1px);
        }
        
        .details-button.active {
            background-color: #3498db;
        }
        
        /* 详情表格样式 */
        .details-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            display: none;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
            }
            to {
                opacity: 1;
                max-height: 500px;
            }
        }
        
        .details-table.show {
            display: table;
        }
        
        .details-table th, .details-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
            transition: background-color 0.2s ease;
        }
        
        .details-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }
        
        .details-table tr:hover {
            background-color: #f8f9fa;
        }
        
        /* 无结果提示 */
        .no-results {
            text-align: center;
            padding: 80px 20px;
            color: #666;
            font-size: 18px;
            background-color: #fafafa;
            border-radius: 12px;
            border: 2px dashed #e0e0e0;
        }
        
        /* 错误提示 */
        .error-message {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 5px;
            animation: shake 0.5s ease;
        }
        
        @keyframes shake {
            0%, 100% {
                transform: translateX(0);
            }
            25% {
                transform: translateX(-5px);
            }
            75% {
                transform: translateX(5px);
            }
        }
        
        .input-error {
            border-color: #e74c3c !important;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1) !important;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .container {
                margin-top: 10px;
                padding: 15px;
                border-radius: 8px;
            }
            
            h1 {
                font-size: 24px;
                margin-bottom: 20px;
            }
            
            .tab-button {
                padding: 12px 20px;
                font-size: 14px;
            }
            
            .radio-group {
                flex-direction: column;
                gap: 15px;
            }
            
            .button-group {
                flex-direction: column;
                gap: 15px;
            }
            
            button {
                width: 100%;
            }
            
            .card-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .result-card {
                padding: 20px 15px;
            }
            
            .details-table th, .details-table td {
                padding: 10px;
                font-size: 14px;
            }
        }
        
        /* 加载动画 */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 通知提示 */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.3s ease, slideOut 0.3s ease 3s forwards;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        .notification.success {
            background-color: #27ae60;
        }
        
        .notification.error {
            background-color: #e74c3c;
        }
        
        .notification.info {
            background-color: #3498db;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>省间电价计算器</h1>
        
        <!-- 标签页切换 -->
        <div class="tab-container">
            <div class="tabs">
                <button class="tab-button active" data-tab="settings">参数设置</button>
                <button class="tab-button" data-tab="results">计算结果</button>
            </div>
            
            <!-- 参数设置页面 -->
            <div id="settings" class="tab-content active">
                <form id="calculator-form">
                <div class="form-group">
                    <label for="send-province">送出省份</label>
                    <select id="send-province" required></select>
                    <div class="error-message hidden" id="send-province-error"></div>
                </div>
                
                <div class="form-group">
                    <label for="receive-province">落地省份</label>
                    <select id="receive-province" required></select>
                    <div class="error-message hidden" id="receive-province-error"></div>
                </div>
                
                <div class="form-group">
                    <label>计算方向</label>
                    <div class="radio-group">
                        <label><input type="radio" name="direction" value="forward" checked> 正向（由上网价 → 落地价）</label>
                        <label><input type="radio" name="direction" value="reverse"> 反向（由落地价 → 上网价）</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label id="price-label" for="price-input">上网电价（元/MWh）</label>
                    <input type="number" id="price-input" step="0.01" min="0" required>
                    <div class="error-message hidden" id="price-input-error"></div>
                </div>
                
                <div class="form-group">
                    <label for="environmental-value">环境价值（元/MWh）</label>
                    <input type="number" id="environmental-value" step="0.01" min="0">
                    <div class="error-message hidden" id="environmental-value-error"></div>
                </div>
                
                <div class="button-group">
                    <button type="submit" class="btn-calculate">计算</button>
                    <button type="button" class="btn-reset" id="reset-button">清空</button>
                </div>
            </form>
            </div>
            
            <!-- 计算结果页面 -->
            <div id="results" class="tab-content">
                <!-- 结果操作工具栏 -->
                <div id="results-toolbar" style="margin-bottom: 20px; text-align: right;">
                    <button id="export-pdf-btn" class="btn-primary" style="display: none;">
                        导出PDF报告
                    </button>
                </div>
                <div id="results-container">
                    <div class="no-results">请在参数设置页面进行计算</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // JavaScript代码将在后续添加
        document.addEventListener('DOMContentLoaded', function() {
            // 全局变量
            let routesData = null;
            
            // 标签页切换功能
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            // 切换标签页函数 - 供其他函数调用
            function switchTab(tabId) {
                // 更新按钮状态
                for (var i = 0; i < tabButtons.length; i++) {
                    // 兼容IE的className操作
                    tabButtons[i].className = tabButtons[i].className.replace(/\bactive\b/g, '').trim();
                }
                var activeButton = document.querySelector('.tab-button[data-tab="' + tabId + '"]');
                if (activeButton) {
                    // 兼容IE的className操作
                    activeButton.className += ' active';
                }
                
                // 更新内容显示
                for (var j = 0; j < tabContents.length; j++) {
                    // 兼容IE的className操作
                    tabContents[j].className = tabContents[j].className.replace(/\bactive\b/g, '').trim();
                    if (tabContents[j].id === tabId) {
                        // 兼容IE的className操作
                        tabContents[j].className += ' active';
                    }
                }
            }
            
            // 计算方向切换时更新价格标签
            var directionRadios = document.querySelectorAll('input[name="direction"]');
            var priceLabel = document.getElementById('price-label');
            
            // 使用普通for循环替代forEach箭头函数，提高IE兼容性
            for (var k = 0; k < directionRadios.length; k++) {
                directionRadios[k].addEventListener('change', function() {
                    if (this.value === 'forward') {
                        priceLabel.textContent = '上网电价（元/MWh）';
                    } else {
                        priceLabel.textContent = '落地电价（元/MWh）';
                    }
                });
            }
            
            // 初始化函数
            function init() {
                loadRoutesData();
                setupEventListeners();
                addValidationListeners();
                
                // 绑定导出PDF按钮事件
                document.getElementById('export-pdf-btn').addEventListener('click', exportToPDF);
            }
            
            // 加载路由数据
            function loadRoutesData() {
                // 显示加载通知
                showNotification('正在加载数据，请稍候...', 'info');
                
                fetch('routes2.json')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`数据加载失败: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        routesData = data;
                        console.log('路由数据加载成功:', routesData);
                        showNotification('数据加载成功！', 'success');
                        
                        // 加载数据后填充省份下拉框
                        populateProvinceDropdowns();
                    })
                    .catch(error => {
                        console.error('数据加载错误:', error);
                        showNotification(`数据加载失败: ${error.message}`, 'error');
                        alert('数据加载失败，请刷新页面重试！');
                    });
            }
            
            // 显示通知
            function showNotification(message, type = 'info') {
                // 避免重复创建通知
                const existingNotification = document.querySelector('.notification');
                if (existingNotification) {
                    existingNotification.remove();
                }
                
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                // 3秒后自动移除
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 3000);
            }
            
            // 设置事件监听器
            function setupEventListeners() {
                // 表单提交事件
                document.getElementById('calculator-form').addEventListener('submit', handleSubmit);
                
                // 重置按钮事件
                document.getElementById('reset-button').addEventListener('click', handleReset);
            }
            
            // 填充省份下拉框
            function populateProvinceDropdowns() {
                if (!routesData || routesData.length === 0) {
                    console.warn('没有数据可填充下拉框');
                    return;
                }
                
                // 使用Map保持顺序并去重
                const sendProvinces = new Map();
                const receiveProvinces = new Map();
                
                // 遍历数据提取省份，排除指定的receive字段
                const excludedReceive = '黑龙江（辽吉'; // 要排除的落地省份
                routesData.forEach(route => {
                    if (route.send && !sendProvinces.has(route.send)) {
                        sendProvinces.set(route.send, true);
                    }
                    if (route.receive && !receiveProvinces.has(route.receive) && route.receive !== excludedReceive) {
                        receiveProvinces.set(route.receive, true);
                    }
                });
                console.log(`提取到的落地省份（已排除${excludedReceive}）:`, [...receiveProvinces.keys()]);
                
                // 获取下拉框元素
                const sendSelect = document.getElementById('send-province');
                const receiveSelect = document.getElementById('receive-province');
                
                // 清空现有选项并添加默认选项
                sendSelect.innerHTML = '<option value="">请选择送出省份</option>';
                receiveSelect.innerHTML = '<option value="">请选择落地省份</option>';
                
                // 添加送出省份选项
                sendProvinces.forEach((_, province) => {
                    const option = document.createElement('option');
                    option.value = province;
                    option.textContent = province;
                    sendSelect.appendChild(option);
                });
                
                // 添加落地省份选项
                receiveProvinces.forEach((_, province) => {
                    const option = document.createElement('option');
                    option.value = province;
                    option.textContent = province;
                    receiveSelect.appendChild(option);
                });
                
                console.log(`填充完成：${sendProvinces.size}个送出省份，${receiveProvinces.size}个落地省份`);
            }
            
            // 处理表单提交
            function handleSubmit(event) {
                event.preventDefault();
                
                // 清空所有错误提示
                clearAllErrors();
                
                // 验证表单
                if (!validateForm()) {
                    return;
                }
                
                // 获取表单数据
                const sendProvince = document.getElementById('send-province').value;
                const receiveProvince = document.getElementById('receive-province').value;
                const isForward = document.querySelector('input[name="direction"][value="forward"]').checked;
                const priceInput = parseFloat(document.getElementById('price-input').value);
                const environmentalValue = parseFloat(document.getElementById('environmental-value').value) || 0;
                
                // 查找匹配的路径
                const matchingRoutes = findMatchingRoutes(sendProvince, receiveProvince);
                
                if (matchingRoutes.length === 0) {
                    showNotification('未找到匹配的输电路径', 'error');
                    return;
                }
                
                try {
                    // 执行计算
                    console.log('开始计算，参数：', {matchingRoutes, isForward, priceInput, environmentalValue});
                    const results = calculateRoutes(matchingRoutes, isForward, priceInput, environmentalValue);
                    
                    console.log('计算结果:', results);
                    if (results.length === 0) {
                        showNotification('计算失败，请稍后重试', 'error');
                        return;
                    }
                    
                    // 切换到结果标签页 - 修改为正确的标签页ID
                    switchTab('results');
                    
                    // 显示结果
                    displayResults(results);
                } catch (error) {
                    console.error('计算过程中发生错误:', error);
                    console.error('错误详情:', error.stack);
                    showNotification(`计算过程中发生错误: ${error.message}`, 'error');
                }
            }
            
            // 验证表单
            function validateForm() {
                var isValid = true;
                
                // 验证省份选择
                var sendProvince = document.getElementById('send-province').value;
                var receiveProvince = document.getElementById('receive-province').value;
                
                if (!sendProvince) {
                    showError('send-province-error', '请选择送出省份');
                    isValid = false;
                }
                
                if (!receiveProvince) {
                    showError('receive-province-error', '请选择落地省份');
                    isValid = false;
                }
                
                // 验证价格输入
                var priceInput = document.getElementById('price-input').value;
                var priceValue = parseFloat(priceInput);
                
                if (!priceInput) {
                    showError('price-input-error', '请输入价格');
                    isValid = false;
                } else if (isNaN(priceValue) || priceValue <= 0) {
                    showError('price-input-error', '请输入有效的正价格');
                    isValid = false;
                }
                
                // 验证环境价值（可选，但如果输入则必须为有效数字）
                var environmentalInput = document.getElementById('environmental-value').value;
                if (environmentalInput) {
                    var environmentalValue = parseFloat(environmentalInput);
                    if (isNaN(environmentalValue) || environmentalValue < 0) {
                        showError('environmental-value-error', '环境价值必须为非负数');
                        isValid = false;
                    }
                }
                
                return isValid;
            }
            
            // 显示错误信息
            function showError(errorId, message) {
                const errorElement = document.getElementById(errorId);
                if (errorElement) {
                    errorElement.textContent = message;
                    errorElement.classList.remove('hidden');
                }
            }
            
            // 清除错误信息
            function clearError(errorId) {
                const errorElement = document.getElementById(errorId);
                if (errorElement) {
                    errorElement.textContent = '';
                    errorElement.classList.add('hidden');
                }
            }
            
            // 显示结果
            function displayResults(results) {
                const resultsContainer = document.getElementById('results-container');
                const exportPdfBtn = document.getElementById('export-pdf-btn');
                
                // 清空结果容器
                resultsContainer.innerHTML = '';
                
                if (!results || results.length === 0) {
                    displayNoResults();
                    exportPdfBtn.style.display = 'none';
                    return;
                }
                
                const isForward = document.querySelector('input[name="direction"][value="forward"]').checked;
                
                // 计算最佳价格（最低的）
                // 正向计算中比较落地电价(endPrice)，反向计算中比较上网电价(startPrice)
                let bestPrice;
                if (document.querySelector('input[name="direction"][value="forward"]').checked) {
                    bestPrice = results[0].endPrice;
                    for (let i = 1; i < results.length; i++) {
                        if (results[i].endPrice < bestPrice) {
                            bestPrice = results[i].endPrice;
                        }
                    }
                } else {
                    bestPrice = results[0].startPrice;
                    for (let i = 1; i < results.length; i++) {
                        if (results[i].startPrice < bestPrice) {
                            bestPrice = results[i].startPrice;
                        }
                    }
                }
                
                // 先创建一个函数用于生成结果卡片
                function createResultCard(result, cardIndex) {
                    const isBestPrice = document.querySelector('input[name="direction"][value="forward"]').checked ? 
                                      result.endPrice === bestPrice : result.startPrice === bestPrice;
                    
                    // 创建结果卡片
                    const card = document.createElement('div');
                    card.className = 'result-card';
                    card.id = `result-card-${cardIndex}`;
                    
                    // 卡片头部
                    const header = document.createElement('div');
                    header.className = 'card-header';
                    
                    const routeInfo = document.createElement('div');
                    routeInfo.className = 'route-info';
                    routeInfo.textContent = `${result.send} → ${result.receive} (${result.routeName})`;
                    
                    header.appendChild(routeInfo);
                    
                    // 如果是最佳价格，添加标签
                    if (isBestPrice) {
                        const bestTag = document.createElement('div');
                        bestTag.className = 'best-price-tag';
                        bestTag.textContent = '最佳价格';
                        header.appendChild(bestTag);
                    }
                    
                    card.appendChild(header);
                    
                    // 价格信息
                    const priceInfo = document.createElement('div');
                    priceInfo.className = 'price-info';
                    
                    // 移除重复的isForward变量定义
                    
                    // 起始价格
                    const startItem = document.createElement('div');
                    startItem.className = 'info-item';
                    const startLabel = document.createElement('span');
                    startLabel.className = 'info-label';
                    startLabel.textContent = isForward ? '上网电价' : '落地电价';
                    const startValue = document.createElement('span');
                    startValue.className = 'info-value';
                    startValue.textContent = `${result.startPrice.toFixed(2)} 元/MWh`;
                    startItem.appendChild(startLabel);
                    startItem.appendChild(startValue);
                    
                    // 输电及线损
                    const transmissionItem = document.createElement('div');
                    transmissionItem.className = 'info-item';
                    const transmissionLabel = document.createElement('span');
                    transmissionLabel.className = 'info-label';
                    transmissionLabel.textContent = '输电及线损';
                    const transmissionValue = document.createElement('span');
                    transmissionValue.className = 'info-value';
                    transmissionValue.textContent = `${result.totalTransmissionAndLoss.toFixed(2)} 元/MWh`;
                    transmissionItem.appendChild(transmissionLabel);
                    transmissionItem.appendChild(transmissionValue);
                    
                    // 环境价值
                    if (result.environmentalValue > 0) {
                        const envItem = document.createElement('div');
                        envItem.className = 'info-item';
                        const envLabel = document.createElement('span');
                        envLabel.className = 'info-label';
                        envLabel.textContent = '环境价值';
                        const envValue = document.createElement('span');
                        envValue.className = 'info-value';
                        envValue.textContent = `${result.environmentalValue.toFixed(2)} 元/MWh`;
                        envItem.appendChild(envLabel);
                        envItem.appendChild(envValue);
                        priceInfo.appendChild(envItem);
                    }
                    
                    // 在反向计算模式下的显示逻辑
                if (!document.querySelector('input[name="direction"][value="forward"]').checked) {
                        // 上网电价（迭代计算得出）
                        const startItem = document.createElement('div');
                        startItem.className = 'info-item';
                        const startLabel = document.createElement('span');
                        startLabel.className = 'info-label';
                        startLabel.textContent = '上网电价';
                        const startValue = document.createElement('span');
                        startValue.className = 'info-value';
                        startValue.style.color = isBestPrice ? '#27ae60' : '#2c3e50';
                        startValue.style.fontSize = '18px';
                        startValue.textContent = `${result.startPrice.toFixed(2)} 元/MWh`;
                        startItem.appendChild(startLabel);
                        startItem.appendChild(startValue);
                        
                        // 落地电价（用户输入）
                        const endItem = document.createElement('div');
                        endItem.className = 'info-item';
                        const endLabel = document.createElement('span');
                        endLabel.className = 'info-label';
                        endLabel.textContent = '落地电价';
                        const endValue = document.createElement('span');
                        endValue.className = 'info-value';
                        endValue.textContent = `${result.endPrice.toFixed(2)} 元/MWh`;
                        endItem.appendChild(endLabel);
                        endItem.appendChild(endValue);
                        
                        // 输电及线损
                        const transmissionItem = document.createElement('div');
                        transmissionItem.className = 'info-item';
                        const transmissionLabel = document.createElement('span');
                        transmissionLabel.className = 'info-label';
                        transmissionLabel.textContent = '输电及线损';
                        const transmissionValue = document.createElement('span');
                        transmissionValue.className = 'info-value';
                        transmissionValue.textContent = `${result.totalTransmissionAndLoss.toFixed(2)} 元/MWh`;
                        transmissionItem.appendChild(transmissionLabel);
                        transmissionItem.appendChild(transmissionValue);
                        
                        // 添加信息项到价格信息容器（只添加这三个，不添加重复的价格）
                        priceInfo.appendChild(startItem);
                        priceInfo.appendChild(transmissionItem);
                        priceInfo.appendChild(endItem);
                    } else {
                        // 正向计算模式保持原逻辑
                        // 添加信息项到价格信息容器
                        priceInfo.appendChild(startItem);
                        priceInfo.appendChild(transmissionItem);
                        
                        // 最终价格（落地电价）
                        const endItem = document.createElement('div');
                        endItem.className = 'info-item';
                        const endLabel = document.createElement('span');
                        endLabel.className = 'info-label';
                        endLabel.textContent = '落地电价';
                        const endValue = document.createElement('span');
                        endValue.className = 'info-value';
                        endValue.style.color = isBestPrice ? '#27ae60' : '#2c3e50';
                        endValue.style.fontSize = '18px';
                        endValue.textContent = `${result.endPrice.toFixed(2)} 元/MWh`;
                        endItem.appendChild(endLabel);
                        endItem.appendChild(endValue);
                        priceInfo.appendChild(endItem);
                    }
                    
                    card.appendChild(priceInfo);
                    
                    // 添加详情按钮
                    const detailsBtn = document.createElement('button');
                    detailsBtn.className = 'details-button';
                    detailsBtn.textContent = '查看详情';
                    detailsBtn.setAttribute('data-card-id', cardIndex);
                    
                    // 详情表格容器
                    const detailsContainer = document.createElement('div');
                    detailsContainer.id = `details-${cardIndex}`;
                    detailsContainer.className = 'details-container';
                    
                    // 创建详情表格
                    const detailsTable = document.createElement('table');
                    detailsTable.className = 'details-table';
                    
                    // 表格头部
                    const thead = document.createElement('thead');
                    const headerRow = document.createElement('tr');
                    
                    const nameHeader = document.createElement('th');
                    nameHeader.textContent = '环节名称';
                    const priceHeader = document.createElement('th');
                    priceHeader.textContent = '输电价（元/MWh）';
                    const lossHeader = document.createElement('th');
                    lossHeader.textContent = '线损率';
                    const discountHeader = document.createElement('th');
                    discountHeader.textContent = '线损折价（元/MWh）';
                    
                    headerRow.appendChild(nameHeader);
                    headerRow.appendChild(priceHeader);
                    headerRow.appendChild(lossHeader);
                    headerRow.appendChild(discountHeader);
                    thead.appendChild(headerRow);
                    
                    // 表格主体
                    const tbody = document.createElement('tbody');
                    
                    // 添加每个环节的详情（保持送端→受端顺序）
                    console.log(`路径 ${result.send} → ${result.receive} 的环节明细顺序:`, result.segmentDetails.map(s => s.name));
                    for (let j = 0; j < result.segmentDetails.length; j++) {
                        const segment = result.segmentDetails[j];
                        const row = document.createElement('tr');
                        
                        const nameCell = document.createElement('td');
                        nameCell.textContent = segment.name;
                        
                        const priceCell = document.createElement('td');
                        priceCell.textContent = segment.price.toFixed(2);
                        
                        const lossCell = document.createElement('td');
                        lossCell.textContent = (segment.lossRate * 100).toFixed(2) + '%';
                        
                        const discountCell = document.createElement('td');
                        discountCell.textContent = segment.lossDiscount.toFixed(2);
                        
                        row.appendChild(nameCell);
                        row.appendChild(priceCell);
                        row.appendChild(lossCell);
                        row.appendChild(discountCell);
                        tbody.appendChild(row);
                    }
                    
                    detailsTable.appendChild(thead);
                    detailsTable.appendChild(tbody);
                    detailsContainer.appendChild(detailsTable);
                    
                    // 绑定详情按钮事件
                    detailsBtn.addEventListener('click', function() {
                        const cardId = this.getAttribute('data-card-id');
                        const detailsTable = document.getElementById(`details-${cardId}`).querySelector('.details-table');
                        
                        if (detailsTable.classList.contains('show')) {
                            detailsTable.classList.remove('show');
                            this.textContent = '查看详情';
                            this.classList.remove('active');
                        } else {
                            detailsTable.classList.add('show');
                            this.textContent = '隐藏详情';
                            this.classList.add('active');
                        }
                    });
                    
                    card.appendChild(detailsBtn);
                    card.appendChild(detailsContainer);
                    
                    return card;
                }
                
                // 先添加最佳价格卡片到容器顶部
                let cardIndex = 0;
                let bestPriceAdded = false;
                
                // 首先找到并添加最佳价格卡片
                for (let i = 0; i < results.length; i++) {
                    const result = results[i];
                    const isBestPrice = document.querySelector('input[name="direction"][value="forward"]').checked ? 
                                       result.endPrice === bestPrice : result.startPrice === bestPrice;
                    
                    if (isBestPrice) {
                        const bestCard = createResultCard(result, cardIndex++);
                        resultsContainer.appendChild(bestCard);
                        bestPriceAdded = true;
                        // 只添加第一个最佳价格卡片（可能有多个相同价格的结果）
                        break;
                    }
                }
                
                // 收集所有非最佳价格结果
                const nonBestResults = [];
                for (let i = 0; i < results.length; i++) {
                    const result = results[i];
                    const isBestPrice = document.querySelector('input[name="direction"][value="forward"]').checked ? 
                                       result.endPrice === bestPrice : result.startPrice === bestPrice;
                    
                    if (!isBestPrice) {
                        nonBestResults.push(result);
                    }
                }
                
                // 对非最佳价格结果按照价格从低到高排序
                nonBestResults.sort((a, b) => {
                    if (document.querySelector('input[name="direction"][value="forward"]').checked) {
                        // 正向计算按落地电价排序
                        return a.endPrice - b.endPrice;
                    } else {
                        // 反向计算按上网电价排序
                        return a.startPrice - b.startPrice;
                    }
                });
                
                // 添加排序后的非最佳价格卡片
                for (let i = 0; i < nonBestResults.length; i++) {
                    const card = createResultCard(nonBestResults[i], cardIndex++);
                    resultsContainer.appendChild(card);
                }
                
                // 显示导出按钮
                exportPdfBtn.style.display = 'inline-block';
            }
            
            // 处理重置按钮点击
            function handleReset() {
                // 重置表单
                const form = document.getElementById('calculator-form');
                form.reset();
                
                // 清空所有错误提示
                clearAllErrors();
                
                // 重置价格标签
                priceLabel.textContent = '上网电价（元/MWh）';
                
                // 切换到设置标签页
                switchTab('settings');
                
                // 显示通知
                showNotification('表单已重置', 'info');
            }
            
            // 添加验证监听器
            function addValidationListeners() {
                // 为所有输入字段添加失焦验证
                const inputs = document.querySelectorAll('select, input');
                inputs.forEach(input => {
                    input.addEventListener('blur', function() {
                        validateField(this);
                    });
                });
            }
            
            // 单个字段验证
            function validateField(field) {
                const fieldId = field.id;
                const errorId = fieldId + '-error';
                
                // 清除之前的错误
                clearError(errorId);
                
                // 根据字段类型进行验证
                if (fieldId === 'send-province' || fieldId === 'receive-province') {
                    if (!field.value) {
                        showError(errorId, fieldId === 'send-province' ? '请选择送出省份' : '请选择落地省份');
                        field.classList.add('input-error');
                    } else {
                        field.classList.remove('input-error');
                    }
                } else if (fieldId === 'price-input') {
                    if (!field.value) {
                        showError(errorId, '请输入价格');
                        field.classList.add('input-error');
                    } else {
                        const value = parseFloat(field.value);
                        if (isNaN(value) || value <= 0) {
                            showError(errorId, '请输入有效的正价格');
                            field.classList.add('input-error');
                        } else {
                            field.classList.remove('input-error');
                        }
                    }
                } else if (fieldId === 'environmental-value') {
                    if (field.value) {
                        const value = parseFloat(field.value);
                        if (isNaN(value) || value < 0) {
                            showError(errorId, '环境价值必须为非负数');
                            field.classList.add('input-error');
                        } else {
                            field.classList.remove('input-error');
                        }
                    } else {
                        field.classList.remove('input-error');
                    }
                }
            }
            
            // 清除所有错误信息
            function clearAllErrors() {
                const errorElements = document.querySelectorAll('.error-message');
                errorElements.forEach(element => {
                    element.textContent = '';
                    element.classList.add('hidden');
                });
                
                // 清除输入框的错误样式
                const inputs = document.querySelectorAll('select, input');
                inputs.forEach(input => {
                    input.classList.remove('input-error');
                });
            }
            
            // 查找匹配的路径
            function findMatchingRoutes(sendProvince, receiveProvince) {
                if (!routesData || routesData.length === 0) {
                    console.error('路由数据未加载');
                    return [];
                }
                
                console.log(`正在查找路径: ${sendProvince} -> ${receiveProvince}`);
                const matches = [];
                
                for (let i = 0; i < routesData.length; i++) {
                    const route = routesData[i];
                    if (route.send === sendProvince && route.receive === receiveProvince) {
                        matches.push(route);
                        console.log(`找到匹配路径:`, route);
                    }
                }
                
                console.log(`找到 ${matches.length} 条匹配路径`);
                return matches;
            }
            
            // 计算路径价格
            function calculateRoutes(routes, isForward, inputPrice, environmentalValue) {
                if (!routes || routes.length === 0) {
                    console.error('没有可计算的路径');
                    return [];
                }
                
                const results = [];
                
                for (let i = 0; i < routes.length; i++) {
                    const route = routes[i];
                    try {
                        const result = calculateSingleRoute(route, isForward, inputPrice, environmentalValue);
                        if (result) {
                            results.push(result);
                        }
                    } catch (error) {
                        console.error(`计算路径 ${i+1} 时出错:`, error);
                    }
                }
                
                return results;
            }
            
            // 计算单个路径的价格
            function calculateSingleRoute(route, isForward, inputPrice, environmentalValue) {
                let startPrice = 0;
                let endPrice = 0;
                let totalTransmissionAndLoss = 0;
                const segmentDetails = [];
                
                // 检查路由数据的完整性
                if (!route || !route.segments || !Array.isArray(route.segments)) {
                    console.error('路由数据不完整:', route);
                    return null;
                }
                
                // 正向计算：上网价 -> 落地价
                if (isForward) {
                    startPrice = inputPrice;
                    let currentPrice = inputPrice;
                    
                    // 遍历所有环节
                    for (let j = 0; j < route.segments.length; j++) {
                        const segment = route.segments[j];
                        if (!segment) continue;
                        
                        // 计算输电价
                        const transmissionPrice = parseFloat(segment.price) || 0;
                        
                        // 计算线损率 - 支持驼峰命名lossRate和下划线命名loss_rate
                        const lossRate = parseFloat(segment.lossRate || segment.loss_rate || 0);
                        
                        // 计算线损折价
                        let lossDiscount = 0;
                        if (lossRate > 0) {
                            lossDiscount = currentPrice * lossRate / (1 - lossRate);
                        }
                        
                        // 更新当前价格
                        currentPrice += transmissionPrice + lossDiscount;
                        
                        // 保存环节详情
                        segmentDetails.push({
                            name: segment.name || `环节${j+1}`,
                            price: transmissionPrice,
                            lossRate: lossRate,
                            lossDiscount: lossDiscount
                        });
                    }
                    
                    // 计算总输电及线损
                    totalTransmissionAndLoss = currentPrice - startPrice;
                    
                    // 最终落地价 = 当前价格 + 环境价值
                    endPrice = currentPrice + environmentalValue;
                } else {
                    // 反向计算：落地价 -> 上网价
                    const L = inputPrice; // L = 用户输入的落地电价（常数）
                    
                    // 使用固定点迭代法求解非线性方程 X + 输电及线损(X) = L
                    let X = L; // 初始猜测：上网价 = 落地价（不考虑损耗）
                    const tolerance = 0.01; // 收敛精度
                    const maxIterations = 100; // 最大迭代次数
                    const relaxationFactor = 0.8; // 松弛因子，加速收敛
                    let iteration = 0;
                    let error = Infinity;
                    
                    // 迭代求解
                    while (error > tolerance && iteration < maxIterations) {
                        // 初始化计算落地价的变量
                        
                        // 正向遍历所有环节（保持原始顺序）计算落地价
                        let cumulativePrice = X; // 累积价格，初始为上网价X
                        calculatedLandingPrice = X; // 初始为上网价
                        
                        for (let j = 0; j < route.segments.length; j++) {
                            const segment = route.segments[j];
                            if (!segment) continue;
                            
                            const transmissionPrice = parseFloat(segment.price) || 0;
                            const lossRate = parseFloat(segment.lossRate || segment.loss_rate || 0);
                            
                            let lossDiscount = 0;
                            if (lossRate > 0) {
                                // 严格按照公式计算：(累积价格 × lossRate) / (1 − lossRate)
                                lossDiscount = cumulativePrice * lossRate / (1 - lossRate);
                            }
                            
                            // 累计电价更新：累计电价 += price_i + 线损折价_i
                            calculatedLandingPrice += transmissionPrice + lossDiscount;
                            // 更新累积价格，用于下一个环节的线损折价计算
                            cumulativePrice += transmissionPrice + lossDiscount;
                        }
                        
                        // 计算误差：|估计落地价 − L| < 0.01
                        error = Math.abs(calculatedLandingPrice - L);
                        
                        // 使用松弛因子更新X，加速收敛
                        // X_new = X_old + 松弛因子 * (L - (calculatedLandingPrice - X_old))
                        // 公式简化：L = X + 输电及线损(X)，所以 X_new = X_old + 松弛因子 * (L - calculatedLandingPrice)
                        X = X + relaxationFactor * (L - calculatedLandingPrice);
                        
                        iteration++;
                    }
                    
                    console.log(`反向计算迭代完成：${iteration}次迭代，误差=${error.toFixed(4)}，求得上网价X=${X.toFixed(4)}`);
                    
                    // 设置正确的价格变量
                    startPrice = X; // 求得的上网电价
                    endPrice = L; // 用户输入的落地电价
                    
                    // 重新正向遍历计算各环节线损详情用于展示
                    let cumulativePrice = X; // 累积价格，初始为上网价X
                    totalTransmissionAndLoss = 0;
                    
                    for (let j = 0; j < route.segments.length; j++) {
                        const segment = route.segments[j];
                        if (!segment) continue;
                        
                        const transmissionPrice = parseFloat(segment.price) || 0;
                        const lossRate = parseFloat(segment.lossRate || segment.loss_rate || 0);
                        
                        let lossDiscount = 0;
                        if (lossRate > 0) {
                            // 严格按照公式计算：(累积价格 × lossRate) / (1 − lossRate)
                            lossDiscount = cumulativePrice * lossRate / (1 - lossRate);
                        }
                        
                        // 保存环节详情（保持送端→受端顺序）
                        segmentDetails.push({
                            name: segment.name || `环节${j+1}`,
                            price: transmissionPrice,
                            lossRate: lossRate,
                            lossDiscount: lossDiscount
                        });
                        
                        // 更新累计值
                        totalTransmissionAndLoss += transmissionPrice + lossDiscount;
                        // 更新累积价格，用于下一个环节的线损折价计算
                        cumulativePrice += transmissionPrice + lossDiscount;
                    }
                    
                    // 环境价值仅在结果展示时使用，不参与方程求解
                }
                
                // 确保数值精度
                startPrice = parseFloat(startPrice.toFixed(2));
                endPrice = parseFloat(endPrice.toFixed(2));
                totalTransmissionAndLoss = parseFloat(totalTransmissionAndLoss.toFixed(2));
                
                return {
                    routeName: route.routeName || route.name || '未知通道',
                    send: route.send,
                    receive: route.receive,
                    startPrice: startPrice,
                    endPrice: endPrice,
                    totalTransmissionAndLoss: totalTransmissionAndLoss,
                    environmentalValue: environmentalValue,
                    segmentDetails: segmentDetails
                };
            }
            
            // 显示无结果状态
            function displayNoResults() {
                const resultsContainer = document.getElementById('results-container');
                resultsContainer.innerHTML = '<p class="no-results">请在参数设置页面输入数据并点击计算</p>';
            }
            
            // PDF导出功能函数 - 优化版本，增强IE兼容性和健壮性
            function exportToPDF() {
                // 添加导出按钮状态管理，防止重复点击
                var exportButton = document.getElementById('export-pdf');
                var originalText = exportButton ? exportButton.textContent : '';
                if (exportButton) {
                    exportButton.disabled = true;
                    exportButton.textContent = '正在导出...';
                }
                try {
                    // 检查必要的库是否已加载
                    if (!window.jspdf || !window.html2canvas) {
                        alert('PDF生成所需的库未完全加载，请刷新页面后重试');
                        return;
                    }
                    
                    // 创建PDF实例
                    var jspdf = window.jspdf;
                    var pdf = new jspdf.jsPDF('p', 'mm', 'a4');
                    
                    // 获取结果内容
                    var resultsContainer = document.getElementById('results-container');
                    if (!resultsContainer || resultsContainer.innerHTML.trim() === '' || 
                        resultsContainer.querySelector('.no-results')) {
                        alert('暂无计算结果可导出');
                        return;
                    }
                    
                    // 展开所有详情卡片以便完整导出
                    var toggleButtons = document.querySelectorAll('.details-button');
                    var expandedStates = [];
                    for (var i = 0; i < toggleButtons.length; i++) {
                        var btn = toggleButtons[i];
                        var cardId = btn.getAttribute('data-card-id');
                        // IE兼容：使用getElementById和字符串拼接替代模板字符串
                        var detailsContainer = document.getElementById('details-' + cardId);
                        if (detailsContainer) {
                            var detailsTable = detailsContainer.querySelector('.details-table');
                            // IE兼容：使用className包含检查替代classList.contains
                            var isShown = detailsTable.className.indexOf('show') !== -1;
                            if (!isShown) {
                                expandedStates[i] = false;
                                btn.click(); // 展开详情
                            } else {
                                expandedStates[i] = true;
                            }
                        } else {
                            expandedStates[i] = true;
                        }
                    }
                    
                    // 显示加载提示
                    var loadingDiv = document.createElement('div');
                    loadingDiv.className = 'loading-overlay';
                    loadingDiv.innerHTML = '<div class="loading-text">正在生成PDF报告，请稍候...</div>';
                    loadingDiv.style.cssText = "position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 9999; font-family: Arial, sans-serif;";
                    loadingDiv.querySelector('.loading-text').style.cssText = "background-color: white; padding: 20px 30px; border-radius: 8px; font-size: 16px; color: #333; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);";
                    document.body.appendChild(loadingDiv);
                    
                    // 创建日期对象
                    var date = new Date();
                    
                    // 等待DOM更新完成，然后进行PDF生成
                    setTimeout(function() {
                        // 使用原始的results-container进行渲染
                        var elementToCapture = resultsContainer;
                        
                        // 保存原始样式
                        var originalStyles = {
                            position: elementToCapture.style.position,
                            left: elementToCapture.style.left,
                            top: elementToCapture.style.top,
                            zIndex: elementToCapture.style.zIndex,
                            backgroundColor: elementToCapture.style.backgroundColor,
                            width: elementToCapture.style.width,
                            padding: elementToCapture.style.padding
                        };
                        
                        // 应用临时样式以确保正确渲染
                        elementToCapture.style.position = 'relative';
                        elementToCapture.style.zIndex = '1000';
                        elementToCapture.style.backgroundColor = 'white';
                        elementToCapture.style.width = '100%';
                        elementToCapture.style.padding = '20px 0';
                        
                        // 强制重绘
                        elementToCapture.style.display = 'none';
                        elementToCapture.offsetHeight; // 触发重绘
                        elementToCapture.style.display = 'block';
                        
                        // 等待样式完全应用
                        setTimeout(function() {
                            try {
                                // 使用简单可靠的html2canvas配置，增加IE兼容性
                                var canvas = html2canvas(elementToCapture, {
                                    scale: 2,
                                    useCORS: true,
                                    backgroundColor: '#ffffff',
                                    allowTaint: true,
                                    logging: false,
                                    imageTimeout: 20000,
                                    removeContainer: false,
                                    // 添加对IE的特殊配置
                                    letterRendering: true,
                                    foreignObjectRendering: false
                                });
                                
                                // 兼容Promise的处理方式
                                if (canvas && canvas.then) {
                                    // 现代浏览器使用Promise
                                    canvas.then(function(resultCanvas) {
                                        processCanvas(resultCanvas, elementToCapture, originalStyles, toggleButtons, expandedStates, date, pdf, loadingDiv);
                                    }).catch(function(error) {
                                        handleCanvasError(error, elementToCapture, originalStyles, loadingDiv);
                                    });
                                } else {
                                    // 假设是同步返回的canvas（某些IE兼容模式）
                                    processCanvas(canvas, elementToCapture, originalStyles, toggleButtons, expandedStates, date, pdf, loadingDiv);
                                }
                            } catch (error) {
                                handleCanvasError(error, elementToCapture, originalStyles, loadingDiv);
                            }
                        }, 1000);
                    }, 500);
                } catch (error) {
                    console.error('PDF导出函数执行失败:', error);
                    alert('PDF导出功能发生错误，请刷新页面后重试');
                } finally {
                    // 无论成功失败，都恢复按钮状态
                    if (exportButton) {
                        exportButton.disabled = false;
                        exportButton.textContent = originalText;
                    }
                }
            }
            
            // 处理canvas数据并生成PDF的辅助函数
            function processCanvas(canvas, elementToCapture, originalStyles, toggleButtons, expandedStates, date, pdf, loadingDiv) {
                try {
                    // 恢复原始元素样式
                    for (var prop in originalStyles) {
                        if (originalStyles.hasOwnProperty(prop)) {
                            elementToCapture.style[prop] = originalStyles[prop];
                        }
                    }
                    
                    // 恢复原始展开状态
                    for (var j = 0; j < toggleButtons.length; j++) {
                        if (!expandedStates[j]) {
                            toggleButtons[j].click();
                        }
                    }
                    
                    // 创建带标题的新canvas
                    var titleCanvas = document.createElement('canvas');
                    var titleCtx = titleCanvas.getContext('2d');
                    
                    // 设置标题canvas的尺寸
                    var titleHeight = 100;
                    titleCanvas.width = canvas.width;
                    titleCanvas.height = canvas.height + titleHeight;
                    
                    // 填充白色背景
                    titleCtx.fillStyle = '#ffffff';
                    titleCtx.fillRect(0, 0, titleCanvas.width, titleCanvas.height);
                    
                    // 绘制标题
                    titleCtx.font = "bold 36px Arial, sans-serif";
                    titleCtx.fillStyle = '#333333';
                    titleCtx.textAlign = 'center';
                    titleCtx.fillText('省间电价计算报告', titleCanvas.width / 2, 40);
                        
                    // 绘制日期
                    titleCtx.font = "16px Arial, sans-serif";
                    titleCtx.fillStyle = '#666666';
                    var year = date.getFullYear();
                    var month = (date.getMonth() + 1).toString();
                    if (month.length === 1) month = '0' + month;
                    var day = date.getDate().toString();
                    if (day.length === 1) day = '0' + day;
                    var hours = date.getHours().toString();
                    if (hours.length === 1) hours = '0' + hours;
                    var minutes = date.getMinutes().toString();
                    if (minutes.length === 1) minutes = '0' + minutes;
                    var dateStr = '生成日期: ' + year + '-' + month + '-' + day + ' ' + hours + ':' + minutes;
                    titleCtx.fillText(dateStr, titleCanvas.width / 2, 70);
                    
                    // 在标题下方绘制原始内容
                    titleCtx.drawImage(canvas, 0, titleHeight);
                    
                    // 转换为图片数据
                    var imgData = titleCanvas.toDataURL('image/jpeg', 1.0);
                    var imgWidth = 210; // A4宽度，单位mm
                    var pageHeight = 297; // A4高度，单位mm
                    var imgHeight = titleCanvas.height * imgWidth / titleCanvas.width;
                    var heightLeft = imgHeight;
                    var position = 0;
                    
                    // 添加图像到PDF
                    pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                    
                    // 处理多页情况
                    while (heightLeft > 0) {
                        position = -heightLeft;
                        pdf.addPage();
                        pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }
                    
                    // 保存PDF
                    var filename = '省间电价计算报告_' + year + month + day + '.pdf';
                    pdf.save(filename);
                    
                } catch (innerError) {
                    console.error('处理canvas数据失败:', innerError);
                    alert('PDF生成过程中出现错误，请重试');
                } finally {
                    // 清理DOM
                    if (loadingDiv.parentNode) {
                        document.body.removeChild(loadingDiv);
                    }
                }
            }
            
            // 处理canvas生成错误的辅助函数
            function handleCanvasError(error, elementToCapture, originalStyles, loadingDiv) {
                console.error('生成canvas失败:', error);
                alert('PDF生成失败，请重试');
                
                // 恢复原始元素样式
                for (var prop in originalStyles) {
                    elementToCapture.style[prop] = originalStyles[prop];
                }
                
                // 清理DOM
                if (loadingDiv.parentNode) {
                    document.body.removeChild(loadingDiv);
                }
            }
            
            // 调试函数 - 测试路由数据处理（IE兼容版本）
            function debugRouteProcessing() {
                // IE兼容：确保console对象存在
                if (typeof console === 'undefined') {
                    window.console = {
                        log: function() {},
                        error: function() {}
                    };
                }
                
                console.log('开始测试路由数据处理...');
                
                // 模拟使用routeName属性的路由数据（类似错误日志中的格式）
                var testRoute = {
                    send: '蒙东',
                    receive: '天津',
                    routeName: '鲁固直流',
                    segments: [
                        { price: '10', lossRate: '0.05' },
                        { price: '15', loss_rate: '0.03' },
                        { price: '12', lossRate: '0.02' }
                    ]
                };
                
                // 测试路由数据处理
                var result = calculateSingleRoute(testRoute, true, 500, 0);
                console.log('测试结果:', result);
                
                // 验证结果
                if (result) {
                    console.log('路由数据处理成功！');
                    alert('调试测试成功：路由数据处理正常');
                } else {
                    console.log('路由数据处理失败');
                    alert('调试测试失败：路由数据处理异常');
                }
            }
            
            // 初始化应用
            init();
            
            // 可选：取消注释下方代码以在页面加载时自动运行调试测试
            // setTimeout(debugRouteProcessing, 1000);
        });
    </script>
</body>
</html>